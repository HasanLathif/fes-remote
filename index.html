<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>RUBIFlex Pro Remote (v3.2)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* TEMA WARNA */
        :root {
            --background-color: #963930;
            --card-background: #fdf6f2;
            --text-color: #2d3436;
            --text-secondary: #636e72;
            --border-color: #dfe6e9;        
            --primary-color: #0984e3;
            --success-color: #00b894;
            --danger-color: #d63031;
            --slider-track: #b2bec3;
            --gauge-fill: #0984e3;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color:var(--background-color); color:var(--text-color); margin:0; padding:1rem; display:flex; justify-content:center; min-height:100vh; box-sizing:border-box; }
        .container { width:100%; max-width:550px; padding-top: 50px; padding-bottom: 50px; }
        
        /* LOGO */
        #fixedLogo { position: fixed; top: 15px; right: 15px; width: 60px; height: auto; z-index: 2000; filter: drop-shadow(0px 2px 2px rgba(0,0,0,0.3)); }

        .card { background-color:var(--card-background); border-radius:16px; box-shadow:0 8px 20px rgba(0,0,0,0.2); padding:1.5rem; margin-bottom:1rem; animation: fadeIn 0.4s ease-out; }
        #loginScreen, #homeScreen, #manualModeScreen, #autoModeScreen, #historyScreen { display:none; }

        h1 { font-size:1.8rem; margin-bottom:0.5rem; text-align: center; color: var(--background-color); }
        h2 { font-size:1.2rem; font-weight:700; margin-bottom:1rem; border-bottom:2px solid var(--border-color); padding-bottom:0.5rem; color: var(--text-color); }
        
        /* INPUTS (FIXED WIDTH) */
        .login-form label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--text-secondary); }
        /* Memastikan input memenuhi lebar container */
        .login-form input { 
            width: 100%; 
            padding: 14px; /* Padding lebih besar */
            margin-bottom: 20px; 
            border: 2px solid #ccc; /* Border lebih jelas */
            border-radius: 8px; 
            font-size: 1.1rem; /* Font lebih besar */
            box-sizing: border-box; /* Kunci agar padding tidak menambah lebar */
            background-color: white;
        }
        .login-form input:focus { border-color: var(--primary-color); outline: none; }

        .control-group { margin-bottom:1.5rem; }
        label { display:block; margin-bottom:0.3rem; font-weight:600; color:var(--text-secondary); }
        .param-desc { font-size: 0.8rem; color: #888; margin-bottom: 8px; font-style: italic; display: block; }
        
        input[type="range"] { -webkit-appearance:none; width:100%; height:10px; background:var(--slider-track); border-radius:5px; outline:none; cursor:pointer; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance:none; width:24px; height:24px; background:var(--primary-color); cursor:pointer; border-radius:50%; border:3px solid #fff; box-shadow:0 2px 5px rgba(0,0,0,0.2); }
        .input-value-container { display:flex; align-items:center; justify-content:flex-end; gap:0.5rem; margin-top: 5px; }
        input[type="number"] { width:70px; padding:5px; border:1px solid var(--border-color); border-radius:6px; font-size:1rem; text-align:right; }

        /* BUTTONS */
        button { width:100%; padding:12px; font-size:1rem; font-weight:bold; border:none; border-radius:10px; cursor:pointer; color: white; margin-bottom: 10px; transition: 0.2s; }
        button:active { transform:scale(0.98); }
        .btn-primary { background: var(--primary-color); }
        .btn-success { background: var(--success-color); }
        .btn-danger { background: var(--danger-color); }
        .btn-secondary { background-color: #b2bec3; color: var(--text-color); }
        .btn-outline { background: transparent; border: 2px solid var(--text-secondary); color: var(--text-secondary); }
        
        /* Tombol kecil untuk history */
        .btn-sm { width: auto; padding: 6px 12px; font-size: 0.85rem; margin: 0; display: inline-block; }

        /* BATTERY SVG */
        #batteryStatus { display: none; justify-content: center; align-items: center; gap: 10px; margin-top: 10px; }
        svg.battery-svg { width: 50px; height: 24px; }
        .battery-frame { fill: none; stroke: var(--text-color); stroke-width: 2; }
        .battery-cap { fill: var(--text-color); }
        #batteryFill { fill: var(--success-color); transition: width 0.3s; }
        #batteryText { font-size: 10px; font-weight: bold; fill: #000; }

        /* SENSORS & GAUGES */
        .sensor-row { display: flex; gap: 10px; margin-bottom: 1rem; }
        .sensor-box { flex: 1; background: #fff; padding: 10px; border-radius: 10px; border: 1px solid var(--border-color); text-align: center; }
        .sensor-title { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px; }
        .sensor-val { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); }
        .gauge-bar { height: 8px; background: var(--slider-track); border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .gauge-fill { height: 100%; width: 0%; background: var(--gauge-fill); transition: width 0.2s; }

        /* CHART & HISTORY */
        .chart-container { position: relative; height: 200px; width: 100%; margin-top: 1rem; }
        .history-item { background: white; border: 1px solid var(--border-color); padding: 10px; border-radius: 8px; margin-bottom: 8px; }
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .history-tag { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; text-transform: uppercase; }
        .tag-session { background: #e3f2fd; color: #0984e3; }
        .tag-preset { background: #fff3cd; color: #f39c12; }
        .history-detail { font-size: 0.85rem; color: #555; line-height: 1.4; margin-bottom: 8px; }
        .history-actions { display: flex; gap: 8px; justify-content: flex-end; }
        
        #storageInfo { text-align: center; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 1rem; background: #f1f2f6; padding: 5px; border-radius: 5px; }

        /* TOGGLE SWITCH */
        .switch { position:relative; display:inline-block; width:46px; height:24px; }
        .switch input { opacity:0; width:0; height:0; }
        .switch-slider { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background-color:#ccc; transition:.4s; border-radius:24px; }
        .switch-slider:before { position:absolute; content:""; height:18px; width:18px; left:3px; bottom:3px; background-color:white; transition:.4s; border-radius:50%; }
        input:checked + .switch-slider { background-color:var(--success-color); }
        input:checked + .switch-slider:before { transform:translateX(22px); }
        .control-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }

    </style>
</head>
<body>

    <img id="fixedLogo" src="rubiflex_logo.png" alt="Logo">

    <div class="container">

        <div id="loginScreen" style="display: block;">
            <div class="card">
                <h1>RUBIFlex</h1>
                <p style="text-align:center; color:var(--text-secondary);">Sistem Rehabilitasi Cerdas</p>
                <br>
                <div class="login-form">
                    <label>Nama Pasien</label>
                    <input type="text" id="inputName" placeholder="Contoh: Budi Santoso">
                    
                    <label>Nomor Telepon (ID)</label>
                    <input type="tel" id="inputPhone" placeholder="08xxxxxxxxxx">
                    
                    <button class="btn-primary" onclick="handleLogin()">Masuk & Mulai Sesi</button>
                    <button class="btn-outline" onclick="handleGuest()">Lanjut sebagai Tamu</button>
                </div>
            </div>
        </div>

        <div id="homeScreen">
            <div class="card">
                <div id="currentUserDisplay" style="text-align:center; margin-bottom:10px; color:var(--text-secondary);">Halo, Tamu</div>
                <button id="connectButton" class="btn-primary">Connect Device</button>
                <div id="status" style="text-align:center; padding:8px; background:#eee; border-radius:8px; font-weight:600; font-size:0.9rem;">Disconnected</div>
                
                <div id="batteryStatus">
                    <div class="battery-container" style="display:flex; align-items:center; gap:5px;">
                        <svg class="battery-svg" viewBox="0 0 34 16">
                            <rect class="battery-frame" x="1" y="1" width="30" height="14" rx="2"></rect>
                            <rect class="battery-cap" x="31" y="4" width="2" height="8" rx="1"></rect>
                            <rect id="batteryFill" x="3" y="3" width="0" height="10" rx="1"></rect>
                        </svg>
                        <span id="batteryText">--%</span>
                    </div>
                    <div id="batteryVoltageText" style="font-size:0.8rem; color:var(--text-secondary);">-- V</div>
                </div>

                <hr style="margin: 1.5rem 0; border-top:1px solid #ddd;">

                <button class="btn-success" onclick="goToManual()">Mode Manual</button>
                <button class="btn-success" onclick="goToAuto()">Mode Otomatis</button>
                <button class="btn-secondary" onclick="goToHistory()">Riwayat Pasien</button>
                <button class="btn-danger" onclick="logout()">Keluar</button>
            </div>
        </div>

        <div id="manualModeScreen">
            <div class="card">
                <button class="btn-secondary" onclick="goHome()">Kembali</button>
                <button class="btn-primary" onclick="saveManualPreset()" style="margin-bottom:15px;">üíæ Simpan Preset Ini</button>
                <h2>Mode Manual</h2>
                
                <div class="sensor-row">
                    <div class="sensor-box">
                        <div class="sensor-title">Grip (C1)</div>
                        <div id="manGripVal" class="sensor-val">0¬∞</div>
                        <div class="gauge-bar"><div id="manGripGauge" class="gauge-fill"></div></div>
                    </div>
                    <div class="sensor-box">
                        <div class="sensor-title">Bicep (C2)</div>
                        <div id="manBicepVal" class="sensor-val">0¬∞</div>
                        <div class="gauge-bar"><div id="manBicepGauge" class="gauge-fill"></div></div>
                    </div>
                </div>

                <div class="control-group">
                    <div class="control-header"><span>Channel 1 (Grip)</span> <label class="switch"><input type="checkbox" id="ch1Enable"><span class="switch-slider"></span></label></div>
                    <span class="param-desc">Kekuatan stimulasi otot lengan bawah (Genggam).</span>
                    <input type="range" id="ch1AmpSlider" min="0" max="255" value="0">
                    <div class="input-value-container"><input type="number" id="ch1AmpInput" value="0"></div>
                </div>

                <div class="control-group">
                    <div class="control-header"><span>Channel 2 (Bicep)</span> <label class="switch"><input type="checkbox" id="ch2Enable"><span class="switch-slider"></span></label></div>
                    <span class="param-desc">Kekuatan stimulasi otot lengan atas (Tekuk).</span>
                    <input type="range" id="ch2AmpSlider" min="0" max="255" value="0">
                    <div class="input-value-container"><input type="number" id="ch2AmpInput" value="0"></div>
                </div>

                <div class="card" style="background:#f1f2f6; margin-top:1rem;">
                    <h3>Global Settings</h3>
                    
                    <label>Pulse Width (¬µs)</label>
                    <span class="param-desc">Lebar denyut. Semakin tinggi, penetrasi otot semakin dalam & kuat.</span>
                    <input type="range" id="pwSlider" min="50" max="3000" value="200" step="10">
                    <div class="input-value-container"><input type="number" id="pwInput" value="200"></div>
                    
                    <label style="margin-top:15px;">Frequency (Hz)</label>
                    <span class="param-desc">Kecepatan denyut per detik. Mengatur kehalusan kontraksi otot.</span>
                    <input type="range" id="freqSlider" min="1" max="150" value="30">
                    <div class="input-value-container"><input type="number" id="freqInput" value="30"></div>
                </div>
            </div>
        </div>

        <div id="autoModeScreen">
            <div class="card">
                <button class="btn-secondary" onclick="goHome()">Stop & Simpan</button>
                <h2>Mode Otomatis</h2>
                <div style="text-align:center; color:var(--danger-color); font-weight:bold; margin-bottom:10px;" id="recordingStatus">üî¥ Merekam Data...</div>

                <div class="sensor-row">
                    <div class="sensor-box">
                        <div class="sensor-title">Grip (C1)</div>
                        <div id="autoGripValDisplay" class="sensor-val">0¬∞</div>
                        <div class="gauge-bar"><div id="autoGripGauge" class="gauge-fill"></div></div>
                    </div>
                    <div class="sensor-box">
                        <div class="sensor-title">Bicep (C2)</div>
                        <div id="autoBicepValDisplay" class="sensor-val">0¬∞</div>
                        <div class="gauge-bar"><div id="autoBicepGauge" class="gauge-fill"></div></div>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="sessionChart"></canvas>
                </div>

                <div style="display:flex; gap:10px; margin-top:1rem;">
                    <div style="flex:1;">
                        <label>Target Grip</label>
                        <input type="number" id="targetGrip" value="270" style="width:100%">
                    </div>
                    <div style="flex:1;">
                        <label>Target Bicep</label>
                        <input type="number" id="targetBicep" value="90" style="width:100%">
                    </div>
                </div>

                <div style="margin-top:1rem; text-align:center;">
                    <div>Amp C1 (Auto): <span id="autoC1Readout" style="font-weight:bold; color:var(--primary-color);">0</span></div>
                    <div>Amp C2 (Auto): <span id="autoC2Readout" style="font-weight:bold; color:var(--primary-color);">0</span></div>
                </div>
            </div>
        </div>

        <div id="historyScreen">
            <div class="card">
                <button class="btn-secondary" onclick="goHome()">Kembali</button>
                <h2>Riwayat Terapi</h2>
                
                <div id="storageInfo">Memuat Info Penyimpanan...</div>

                <div id="historyList">
                    <p style="text-align:center; color:#888;">Belum ada data rekaman.</p>
                </div>
            </div>
        </div>

    </div>

    <script>
        const FES_SERVICE = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
        const FES_CHAR = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
        const SENSOR_SERVICE = "0000180f-0000-1000-8000-00805f9b34fb";
        const SENSOR_CHAR = "00002a19-0000-1000-8000-00805f9b34fb";
        
        let bleDevice, controlChar, sensorChar;
        let isConnected = false;
        const encoder = new TextEncoder();
        const decoder = new TextDecoder();

        let currentUser = null;
        let currentSessionData = [];
        let isRecording = false;
        let recordingStartTime = 0;
        let chartInstance = null;

        // --- USER & DATA ---
        function handleLogin() {
            const name = document.getElementById('inputName').value.trim();
            const phone = document.getElementById('inputPhone').value.trim();
            if(!name || !phone) { alert("Isi nama dan nomor."); return; }
            const userKey = `rubiflex_${name.toLowerCase().replace(/\s/g,'')}_${phone}`;
            currentUser = { name: name, phone: phone, key: userKey };
            document.getElementById('currentUserDisplay').textContent = `Pasien: ${name}`;
            showScreen('homeScreen');
        }

        function handleGuest() {
            currentUser = null;
            document.getElementById('currentUserDisplay').textContent = "Mode Tamu";
            showScreen('homeScreen');
        }

        function logout() {
            currentUser = null;
            if(isConnected) disconnect();
            showScreen('loginScreen');
        }

        function showScreen(id) {
            ['loginScreen', 'homeScreen', 'manualModeScreen', 'autoModeScreen', 'historyScreen'].forEach(s => document.getElementById(s).style.display = 'none');
            document.getElementById(id).style.display = 'block';
        }

        function saveManualPreset() {
            if(!currentUser) { alert("Mode Tamu tidak bisa menyimpan preset."); return; }
            const preset = {
                type: 'preset',
                date: new Date().toLocaleString(),
                data: {
                    c1: document.getElementById('ch1AmpInput').value,
                    c2: document.getElementById('ch2AmpInput').value,
                    pw: document.getElementById('pwInput').value,
                    freq: document.getElementById('freqInput').value
                }
            };
            let history = JSON.parse(localStorage.getItem(currentUser.key)) || [];
            history.push(preset);
            localStorage.setItem(currentUser.key, JSON.stringify(history));
            alert("Preset Berhasil Disimpan!");
        }

        // --- STORAGE MANAGEMENT (NEW v3.2) ---
        function getStorageUsage() {
            // Hitung estimasi penggunaan storage dalam KB
            let total = 0;
            if(currentUser && localStorage.getItem(currentUser.key)){
                const data = localStorage.getItem(currentUser.key);
                total = data.length * 2; // UTF-16 uses 2 bytes per char
            }
            return (total / 1024).toFixed(2);
        }

        function deleteHistoryItem(reverseIndex) {
            if(!confirm("Yakin ingin menghapus data ini? Data tidak bisa dikembalikan.")) return;
            
            const history = JSON.parse(localStorage.getItem(currentUser.key));
            const realIndex = (history.length - 1) - reverseIndex; // Convert back from reversed view
            
            history.splice(realIndex, 1); // Remove item
            localStorage.setItem(currentUser.key, JSON.stringify(history)); // Save back
            
            renderHistory(); // Refresh view
        }

        // --- NAVIGATION ---
        function goToManual() { 
            showScreen('manualModeScreen'); 
            sendCommand('AM:E:0'); 
        }
        
        async function goToAuto() { 
            showScreen('autoModeScreen');
            startRecording();
            const tg = document.getElementById('targetGrip').value;
            const tb = document.getElementById('targetBicep').value;
            sendCommand(`AM:G:${tg}`);
            await new Promise(r => setTimeout(r, 100));
            sendCommand(`AM:B:${tb}`);
            await new Promise(r => setTimeout(r, 100));
            sendCommand('AM:E:1'); 
        }

        function goHome() {
            if(isRecording) stopRecording();
            sendCommand('AM:E:0');
            sendCommand('C1:A:0');
            sendCommand('C2:A:0');
            resetSliders();
            showScreen('homeScreen');
        }

        function goToHistory() {
            renderHistory();
            showScreen('historyScreen');
        }

        // --- CHART & RECORDING ---
        function initChart() {
            const ctx = document.getElementById('sessionChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Grip (¬∞)', data: [], borderColor: '#e17055', tension: 0.1 },
                        { label: 'Bicep (¬∞)', data: [], borderColor: '#0984e3', tension: 0.1 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, animation: false,
                    scales: { y: { beginAtZero: true, max: 270 } }
                }
            });
        }

        function startRecording() {
            currentSessionData = []; isRecording = true; recordingStartTime = Date.now();
            document.getElementById('recordingStatus').style.display = currentUser ? 'block' : 'none';
            initChart();
        }

        function stopRecording() {
            isRecording = false;
            if(!currentUser || currentSessionData.length === 0) return;
            const session = {
                type: 'session',
                date: new Date().toLocaleString(),
                duration: ((Date.now() - recordingStartTime)/1000).toFixed(1) + "s",
                data: currentSessionData
            };
            let history = JSON.parse(localStorage.getItem(currentUser.key)) || [];
            history.push(session);
            localStorage.setItem(currentUser.key, JSON.stringify(history));
            alert("Sesi Terapi Disimpan!");
        }

        // --- BLE LOGIC ---
        document.getElementById('connectButton').addEventListener('click', () => isConnected ? disconnect() : connect());

        async function connect() {
            try {
                updateStatus("Searching...", false);
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [FES_SERVICE] }],
                    optionalServices: [FES_SERVICE, SENSOR_SERVICE]
                });
                bleDevice.addEventListener('gattserverdisconnected', onDisconnect);
                const server = await bleDevice.gatt.connect();
                
                const fes = await server.getPrimaryService(FES_SERVICE);
                controlChar = await fes.getCharacteristic(FES_CHAR);
                
                const sens = await server.getPrimaryService(SENSOR_SERVICE);
                sensorChar = await sens.getCharacteristic(SENSOR_CHAR);
                await sensorChar.startNotifications();
                sensorChar.addEventListener('characteristicvaluechanged', handleNotifications);
                
                isConnected = true;
                updateStatus("Connected ‚úÖ", true);
                document.getElementById('connectButton').textContent = "Disconnect";
                document.getElementById('batteryStatus').style.display = 'flex';
            } catch (e) { console.error(e); updateStatus("Error: " + e.message, false); }
        }

        function disconnect() { if(bleDevice) bleDevice.gatt.disconnect(); }
        function onDisconnect() {
            isConnected = false;
            updateStatus("Disconnected ‚ùå", false);
            document.getElementById('connectButton').textContent = "Connect Device";
            document.getElementById('batteryStatus').style.display = 'none';
            resetSliders();
            if(isRecording) stopRecording();
            showScreen('homeScreen');
        }

        // --- DATA HANDLER ---
        function handleNotifications(event) {
            const str = decoder.decode(event.target.value);
            const p = str.split(':'); 
            if(p.length < 6) return;

            const bicep = parseFloat(p[0]);
            const grip = parseFloat(p[1]);
            const c1 = parseInt(p[2]);
            const c2 = parseInt(p[3]);
            const batP = parseInt(p[4]);
            const batV = parseFloat(p[5]);

            updateGauge('manGrip', grip, 270);
            updateGauge('manBicep', bicep, 120);
            updateGauge('autoGrip', grip, 270);
            updateGauge('autoBicep', bicep, 120);

            document.getElementById('batteryText').textContent = batP + "%";
            document.getElementById('batteryVoltageText').textContent = batV.toFixed(2) + "V";
            document.getElementById('batteryFill').setAttribute('width', (batP/100)*26);
            
            document.getElementById('autoC1Readout').textContent = c1;
            document.getElementById('autoC2Readout').textContent = c2;

            if(isRecording && currentUser) {
                const t = ((Date.now() - recordingStartTime)/1000).toFixed(1);
                currentSessionData.push({t, g:grip, b:bicep, c1, c2});
                if(chartInstance) {
                    if(chartInstance.data.labels.length > 50) {
                        chartInstance.data.labels.shift();
                        chartInstance.data.datasets.forEach(d => d.data.shift());
                    }
                    chartInstance.data.labels.push(t);
                    chartInstance.data.datasets[0].data.push(grip);
                    chartInstance.data.datasets[1].data.push(bicep);
                    chartInstance.update();
                }
            }
        }

        function updateGauge(prefix, val, max) {
            const elVal = document.getElementById(prefix + 'Val') || document.getElementById(prefix + 'ValDisplay');
            const elBar = document.getElementById(prefix + 'Gauge');
            if(elVal) elVal.textContent = val.toFixed(0) + "¬∞";
            if(elBar) elBar.style.width = Math.min((val/max)*100, 100) + "%";
        }

        // --- HISTORY RENDERER (Updated v3.2) ---
        function renderHistory() {
            const list = document.getElementById('historyList');
            const info = document.getElementById('storageInfo');
            list.innerHTML = "";
            
            if(!currentUser) { 
                list.innerHTML = "<p>Mode Tamu.</p>"; 
                info.style.display = 'none';
                return; 
            }
            
            info.style.display = 'block';
            info.textContent = `Penyimpanan Pasien Ini: ${getStorageUsage()} KB (Aman)`;

            const history = JSON.parse(localStorage.getItem(currentUser.key)) || [];
            if(history.length === 0) { list.innerHTML = "<p style='text-align:center'>Kosong.</p>"; return; }

            history.reverse().forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'history-item';
                
                let content = "";
                let actions = "";

                if(item.type === 'preset') {
                    content = `
                        <div class="history-header"><span class="history-tag tag-preset">PRESET</span> <span style="font-size:0.8rem">${item.date}</span></div>
                        <div class="history-detail">
                            <strong>Disimpan:</strong> Grip Amp: ${item.data.c1}, Bicep Amp: ${item.data.c2}<br>
                            PW: ${item.data.pw}¬µs, Freq: ${item.data.freq}Hz
                        </div>`;
                } else {
                    content = `
                        <div class="history-header"><span class="history-tag tag-session">SESI</span> <span style="font-size:0.8rem">${item.date}</span></div>
                        <div class="history-detail">Durasi: ${item.duration}</div>`;
                    actions = `<button class="btn-success btn-sm" onclick="downloadCSV(${idx})">Download</button>`;
                }

                // Delete button for all types
                actions += `<button class="btn-danger btn-sm" onclick="deleteHistoryItem(${idx})">Hapus</button>`;

                div.innerHTML = content + `<div class="history-actions">${actions}</div>`;
                list.appendChild(div);
            });
        }

        function downloadCSV(revIdx) {
            const history = JSON.parse(localStorage.getItem(currentUser.key));
            const realIdx = (history.length - 1) - revIdx;
            const data = history[realIdx].data;
            let csv = "Time(s),Grip(deg),Bicep(deg),AmpC1,AmpC2\n";
            data.forEach(r => csv += `${r.t},${r.g},${r.b},${r.c1},${r.c2}\n`);
            const link = document.createElement("a");
            link.href = encodeURI("data:text/csv;charset=utf-8," + csv);
            link.download = `Sesi_${currentUser.name}.csv`;
            link.click();
        }

        // --- UTILS ---
        async function sendCommand(cmd) {
            if(isConnected && controlChar) controlChar.writeValue(encoder.encode(cmd));
        }
        
        const debounce = (fn, d) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(()=>fn(...a), d); } };
        const sendDebounced = debounce((c) => sendCommand(c), 50);

        function setupSlider(id, prefix) {
            document.getElementById(id+'Slider').addEventListener('input', (e) => {
                document.getElementById(id+'Input').value = e.target.value;
                sendDebounced(`${prefix}:${e.target.value}`);
            });
        }

        setupSlider('ch1Amp', 'C1:A');
        setupSlider('ch2Amp', 'C2:A');
        setupSlider('pw', 'C1:W');
        setupSlider('freq', 'C1:F');

        document.getElementById('ch1Enable').addEventListener('change', (e) => {
            document.getElementById('ch1AmpSlider').value = 0; document.getElementById('ch1AmpInput').value = 0;
            sendCommand(`C1:E:${e.target.checked?1:0}`); sendCommand('C1:A:0');
        });
        document.getElementById('ch2Enable').addEventListener('change', (e) => {
            document.getElementById('ch2AmpSlider').value = 0; document.getElementById('ch2AmpInput').value = 0;
            sendCommand(`C2:E:${e.target.checked?1:0}`); sendCommand('C2:A:0');
        });

        document.getElementById('targetGrip').addEventListener('change', (e) => sendDebounced(`AM:G:${e.target.value}`));
        document.getElementById('targetBicep').addEventListener('change', (e) => sendDebounced(`AM:B:${e.target.value}`));

        function updateStatus(msg, success) {
            const el = document.getElementById('status'); el.textContent = msg;
            el.style.background = success ? '#dff9fb' : '#ff7675';
            el.style.color = success ? '#00b894' : '#fff';
        }

        function resetSliders() {
            ['ch1Amp','ch2Amp'].forEach(id => { document.getElementById(id+'Slider').value=0; document.getElementById(id+'Input').value=0; });
            document.getElementById('ch1Enable').checked=false; document.getElementById('ch2Enable').checked=false;
        }
        
        document.getElementById('pwInput').value = 200;
        document.getElementById('freqInput').value = 30;
    </script>
</body>
</html>
