<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>RUBIFlex Pro Remote (v3.0)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* (TEMA WARNA RUBIFLEX PRO) */
        :root {
            --background-color: #963930;    /* Red Brand */
            --card-background: #fdf6f2;     /* Lebih terang biar bersih */
            --text-color: #2d3436;          /* Dark Grey */
            --text-secondary: #636e72;      /* Grey */
            --border-color: #dfe6e9;        
            --primary-color: #0984e3;       /* Azure Blue yang lebih vivid */
            --primary-hover: #74b9ff;       
            --success-color: #00b894;       /* Green */
            --warning-color: #fdcb6e;       /* Orange */
            --danger-color: #d63031;        /* Red Alert */
            --slider-track: #b2bec3;
            --gauge-fill: #0984e3;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color:var(--background-color); color:var(--text-color); margin:0; padding:1rem; display:flex; justify-content:center; min-height:100vh; box-sizing:border-box; }
        .container { width:100%; max-width:550px; padding-top: 40px; /* Space untuk logo */ }
        
        /* LOGO DI POJOK KANAN ATAS (PERSISTENT) */
        #fixedLogo {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 60px; /* Sesuaikan ukuran */
            height: auto;
            z-index: 2000;
            filter: drop-shadow(0px 2px 2px rgba(0,0,0,0.3));
        }

        .card { 
            background-color:var(--card-background); 
            border-radius:16px; 
            box-shadow:0 8px 20px rgba(0,0,0,0.2); 
            padding:1.5rem; 
            margin-bottom:1rem; 
            animation: fadeIn 0.4s ease-out;
        }
        
        /* Layar */
        #loginScreen, #homeScreen, #manualModeScreen, #autoModeScreen, #historyScreen { display:none; }

        h1 { font-size:1.8rem; margin-bottom:0.5rem; text-align: center; color: var(--background-color); }
        h2 { font-size:1.2rem; font-weight:700; margin-bottom:1rem; border-bottom:2px solid var(--border-color); padding-bottom:0.5rem; color: var(--text-color); }
        
        /* Form Login */
        .login-form input { width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        .login-form label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--text-secondary); }

        /* Controls */
        .control-group { margin-bottom:1.5rem; }
        label { display:block; margin-bottom:0.5rem; font-weight:600; color:var(--text-secondary); }
        input[type="range"] { -webkit-appearance:none; appearance:none; width:100%; height:10px; background:var(--slider-track); border-radius:5px; outline:none; cursor:pointer; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance:none; appearance:none; width:24px; height:24px; background:var(--primary-color); cursor:pointer; border-radius:50%; border:3px solid #fff; box-shadow:0 2px 5px rgba(0,0,0,0.2); }
        
        .input-value-container { display:flex; align-items:center; justify-content:flex-end; gap:0.5rem; }
        input[type="number"] { width:70px; padding:5px; border:1px solid var(--border-color); border-radius:6px; font-size:1rem; text-align:right; }

        /* Buttons */
        button { width:100%; padding:12px; font-size:1rem; font-weight:bold; border:none; border-radius:10px; cursor:pointer; transition:transform 0.1s, opacity 0.2s; color: white; margin-bottom: 10px; }
        button:active { transform:scale(0.98); }
        .btn-primary { background: linear-gradient(135deg, var(--primary-color), var(--primary-hover)); }
        .btn-success { background: linear-gradient(135deg, var(--success-color), #55efc4); }
        .btn-danger { background: linear-gradient(135deg, var(--danger-color), #fab1a0); }
        .btn-secondary { background-color: #b2bec3; color: var(--text-color); }
        .btn-outline { background: transparent; border: 2px solid var(--text-secondary); color: var(--text-secondary); }

        /* Status & Battery */
        #status { text-align:center; padding:8px; border-radius:8px; font-weight:600; margin-bottom:1rem; background: #eee; font-size: 0.9rem; }
        #currentUserDisplay { text-align: center; margin-bottom: 1rem; font-size: 0.9rem; color: var(--text-secondary); font-style: italic; }
        
        /* Battery SVG */
        #batteryStatus { display: none; justify-content: center; align-items: center; gap: 10px; margin-top: 10px; }
        svg.battery-svg { width: 50px; height: 24px; }
        .battery-frame { fill: none; stroke: var(--text-color); stroke-width: 2; }
        .battery-cap { fill: var(--text-color); }
        #batteryFill { fill: var(--success-color); transition: width 0.3s ease, fill 0.3s ease; }
        #batteryText { font-size: 10px; font-weight: bold; fill: #000; }

        /* Sensors & Gauges */
        .sensor-row { display: flex; gap: 10px; margin-bottom: 1rem; }
        .sensor-box { flex: 1; background: #fff; padding: 10px; border-radius: 10px; border: 1px solid var(--border-color); text-align: center; }
        .sensor-title { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px; }
        .sensor-val { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); }
        .gauge-bar { height: 8px; background: var(--slider-track); border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .gauge-fill { height: 100%; width: 0%; background: var(--gauge-fill); transition: width 0.2s; }

        /* Chart Canvas */
        .chart-container { position: relative; height: 200px; width: 100%; margin-top: 1rem; }

        /* History Table */
        .history-item { background: white; border: 1px solid var(--border-color); padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .history-info { font-size: 0.9rem; }
        .history-date { font-size: 0.75rem; color: var(--text-secondary); }

        /* Toggle Switch */
        .switch { position:relative; display:inline-block; width:46px; height:24px; }
        .switch input { opacity:0; width:0; height:0; }
        .switch-slider { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background-color:#ccc; transition:.4s; border-radius:24px; }
        .switch-slider:before { position:absolute; content:""; height:18px; width:18px; left:3px; bottom:3px; background-color:white; transition:.4s; border-radius:50%; }
        input:checked + .switch-slider { background-color:var(--success-color); }
        input:checked + .switch-slider:before { transform:translateX(22px); }
        .control-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }

    </style>
</head>
<body>

    <img id="fixedLogo" src="rubiflex_logo.png" alt="Logo">

    <div class="container">

        <div id="loginScreen" style="display: block;">
            <div class="card">
                <h1>RUBIFlex</h1>
                <p style="text-align:center; color:var(--text-secondary);">Sistem Rehabilitasi Cerdas</p>
                <br>
                <div class="login-form">
                    <label>Nama Pasien</label>
                    <input type="text" id="inputName" placeholder="Contoh: Budi Santoso">
                    
                    <label>Nomor Telepon (ID)</label>
                    <input type="number" id="inputPhone" placeholder="Contoh: 08123456789">
                    
                    <button class="btn-primary" onclick="handleLogin()">Masuk & Mulai Sesi</button>
                    <button class="btn-outline" onclick="handleGuest()">Lanjut sebagai Tamu</button>
                </div>
            </div>
        </div>

        <div id="homeScreen">
            <div class="card">
                <div id="currentUserDisplay">Halo, Tamu</div>
                <button id="connectButton" class="btn-primary">Connect Device (Bluetooth)</button>
                <div id="status">Disconnected</div>
                
                <div id="batteryStatus">
                    <div class="battery-container" style="display:flex; align-items:center; gap:5px;">
                        <svg class="battery-svg" viewBox="0 0 34 16">
                            <rect class="battery-frame" x="1" y="1" width="30" height="14" rx="2"></rect>
                            <rect class="battery-cap" x="31" y="4" width="2" height="8" rx="1"></rect>
                            <rect id="batteryFill" x="3" y="3" width="0" height="10" rx="1"></rect>
                        </svg>
                        <span id="batteryText" style="font-size:0.9rem; font-weight:bold;">--%</span>
                    </div>
                    <div id="batteryVoltageText" style="font-size:0.8rem; color:var(--text-secondary);">-- V</div>
                </div>

                <hr style="margin: 1.5rem 0; border-top:1px solid #ddd;">

                <button class="btn-success" onclick="goToManual()">Mode Manual</button>
                <button class="btn-success" onclick="goToAuto()">Mode Otomatis (Rekam)</button>
                <button class="btn-secondary" onclick="goToHistory()">Riwayat Pasien</button>
                <button class="btn-danger" onclick="logout()">Keluar / Ganti Pasien</button>
            </div>
        </div>

        <div id="manualModeScreen">
            <div class="card">
                <button class="btn-secondary" onclick="goHome()">Kembali</button>
                <h2>Mode Manual</h2>
                
                <div class="sensor-row">
                    <div class="sensor-box">
                        <div class="sensor-title">Grip (C1)</div>
                        <div id="manGripVal" class="sensor-val">0¬∞</div>
                        <div class="gauge-bar"><div id="manGripGauge" class="gauge-fill"></div></div>
                    </div>
                    <div class="sensor-box">
                        <div class="sensor-title">Bicep (C2)</div>
                        <div id="manBicepVal" class="sensor-val">0¬∞</div>
                        <div class="gauge-bar"><div id="manBicepGauge" class="gauge-fill"></div></div>
                    </div>
                </div>

                <div class="control-group">
                    <div class="control-header"><span>Channel 1 (Grip)</span> <label class="switch"><input type="checkbox" id="ch1Enable"><span class="switch-slider"></span></label></div>
                    <input type="range" id="ch1AmpSlider" min="0" max="255" value="0">
                    <div class="input-value-container"><input type="number" id="ch1AmpInput" value="0"></div>
                </div>

                <div class="control-group">
                    <div class="control-header"><span>Channel 2 (Bicep)</span> <label class="switch"><input type="checkbox" id="ch2Enable"><span class="switch-slider"></span></label></div>
                    <input type="range" id="ch2AmpSlider" min="0" max="255" value="0">
                    <div class="input-value-container"><input type="number" id="ch2AmpInput" value="0"></div>
                </div>

                <div class="card" style="background:#f1f2f6; margin-top:1rem;">
                    <h3>Global Settings</h3>
                    <label>Pulse Width (¬µs)</label>
                    <input type="range" id="pwSlider" min="50" max="3000" value="200" step="10">
                    <div class="input-value-container"><input type="number" id="pwInput" value="200"></div>
                    
                    <label style="margin-top:10px;">Frequency (Hz)</label>
                    <input type="range" id="freqSlider" min="1" max="150" value="30">
                    <div class="input-value-container"><input type="number" id="freqInput" value="30"></div>
                </div>
            </div>
        </div>

        <div id="autoModeScreen">
            <div class="card">
                <button class="btn-secondary" onclick="goHome()">Stop & Simpan</button>
                <h2>Mode Otomatis (Live)</h2>
                <div style="text-align:center; color:var(--danger-color); font-weight:bold; font-size:0.9rem; margin-bottom:10px;" id="recordingStatus">üî¥ Merekam Data...</div>

                <div class="chart-container">
                    <canvas id="sessionChart"></canvas>
                </div>

                <div style="display:flex; gap:10px; margin-top:1rem;">
                    <div style="flex:1;">
                        <label>Target Grip</label>
                        <input type="number" id="targetGrip" value="270" style="width:100%">
                    </div>
                    <div style="flex:1;">
                        <label>Target Bicep</label>
                        <input type="number" id="targetBicep" value="90" style="width:100%">
                    </div>
                </div>

                <div style="margin-top:1rem; text-align:center;">
                    <div>Amp C1 (Auto): <span id="autoC1Readout" style="font-weight:bold; color:var(--primary-color);">0</span></div>
                    <div>Amp C2 (Auto): <span id="autoC2Readout" style="font-weight:bold; color:var(--primary-color);">0</span></div>
                </div>
            </div>
        </div>

        <div id="historyScreen">
            <div class="card">
                <button class="btn-secondary" onclick="goHome()">Kembali</button>
                <h2>Riwayat Terapi</h2>
                <div id="historyList">
                    <p style="text-align:center; color:#888;">Belum ada data rekaman.</p>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- 1. GLOBAL VARIABLES ---
        // BLE UUIDs
        const FES_SERVICE = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
        const FES_CHAR = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
        const SENSOR_SERVICE = "0000180f-0000-1000-8000-00805f9b34fb";
        const SENSOR_CHAR = "00002a19-0000-1000-8000-00805f9b34fb";
        
        let bleDevice, controlChar, sensorChar;
        let isConnected = false;
        const encoder = new TextEncoder();
        const decoder = new TextDecoder();

        // User & Data State
        let currentUser = null; // Object {name, phone, key}
        let currentSessionData = []; // Array to store [time, grip, bicep, c1, c2]
        let isRecording = false;
        let recordingStartTime = 0;
        let chartInstance = null;

        // --- 2. USER MANAGEMENT (LOGIN/LOGOUT) ---
        function handleLogin() {
            const name = document.getElementById('inputName').value.trim();
            const phone = document.getElementById('inputPhone').value.trim();
            
            if(!name || !phone) { alert("Mohon isi Nama dan Nomor Telepon."); return; }
            
            // Buat ID unik: 'pasien_nomor' (misal: budi_08123)
            const userKey = `rubiflex_${name.toLowerCase().replace(/\s/g,'')}_${phone}`;
            
            currentUser = { name: name, phone: phone, key: userKey };
            
            document.getElementById('currentUserDisplay').textContent = `Pasien: ${name} (${phone})`;
            showScreen('homeScreen');
        }

        function handleGuest() {
            currentUser = null;
            document.getElementById('currentUserDisplay').textContent = "Mode Tamu (Data tidak disimpan)";
            showScreen('homeScreen');
        }

        function logout() {
            currentUser = null;
            if(isConnected) disconnect();
            document.getElementById('inputName').value = "";
            document.getElementById('inputPhone').value = "";
            showScreen('loginScreen');
        }

        // --- 3. NAVIGATION ---
        function showScreen(id) {
            const screens = ['loginScreen', 'homeScreen', 'manualModeScreen', 'autoModeScreen', 'historyScreen'];
            screens.forEach(s => document.getElementById(s).style.display = 'none');
            document.getElementById(id).style.display = 'block';
        }

        function goToManual() { 
            showScreen('manualModeScreen'); 
            sendCommand('AM:E:0'); // Pastikan Auto mati
        }
        
        function goToAuto() { 
            showScreen('autoModeScreen');
            startRecording(); // Mulai rekam & grafik
            // Kirim target awal
            const tg = document.getElementById('targetGrip').value;
            const tb = document.getElementById('targetBicep').value;
            sendCommand(`AM:G:${tg}`);
            sendCommand(`AM:B:${tb}`);
            sendCommand('AM:E:1'); // Nyalakan Auto Mode di alat
        }

        function goHome() {
            // Jika pulang dari Auto Mode, stop rekaman
            if(isRecording) stopRecording();
            
            sendCommand('AM:E:0'); // Matikan Auto
            sendCommand('C1:A:0'); // Reset Amp
            sendCommand('C2:A:0');
            resetSliders();
            showScreen('homeScreen');
        }

        function goToHistory() {
            renderHistory();
            showScreen('historyScreen');
        }

        // --- 4. RECORDING & CHART LOGIC ---
        function initChart() {
            const ctx = document.getElementById('sessionChart').getContext('2d');
            if(chartInstance) chartInstance.destroy(); // Hapus chart lama jika ada

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [], // Time (detik)
                    datasets: [
                        { label: 'Grip (¬∞)', data: [], borderColor: '#e17055', tension: 0.1 }, // Merah bata
                        { label: 'Bicep (¬∞)', data: [], borderColor: '#0984e3', tension: 0.1 } // Biru
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false, // Matikan animasi biar ringan saat update real-time
                    scales: { y: { beginAtZero: true, max: 270 } }
                }
            });
        }

        function startRecording() {
            currentSessionData = []; // Kosongkan data
            isRecording = true;
            recordingStartTime = Date.now();
            
            if(currentUser) {
                document.getElementById('recordingStatus').style.display = 'block';
            } else {
                document.getElementById('recordingStatus').style.display = 'none'; // Tamu ga direkam
            }
            initChart();
        }

        function stopRecording() {
            isRecording = false;
            if(!currentUser) return; // Tamu tidak simpan data

            // Simpan ke LocalStorage
            if(currentSessionData.length > 0) {
                const sessionRecord = {
                    date: new Date().toLocaleString(),
                    duration: ((Date.now() - recordingStartTime)/1000).toFixed(1) + "s",
                    data: currentSessionData
                };

                // Ambil history lama
                let history = JSON.parse(localStorage.getItem(currentUser.key)) || [];
                history.push(sessionRecord); // Tambah sesi baru
                localStorage.setItem(currentUser.key, JSON.stringify(history)); // Simpan balik
                alert("Data sesi berhasil disimpan!");
            }
        }

        // --- 5. BLE CONNECTION ---
        document.getElementById('connectButton').addEventListener('click', () => isConnected ? disconnect() : connect());

        async function connect() {
            try {
                updateStatus("Mencari Perangkat...", false);
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [FES_SERVICE] }],
                    optionalServices: [FES_SERVICE, SENSOR_SERVICE]
                });
                
                bleDevice.addEventListener('gattserverdisconnected', onDisconnect);
                const server = await bleDevice.gatt.connect();
                
                // Get Services
                const fesSvc = await server.getPrimaryService(FES_SERVICE);
                controlChar = await fesSvc.getCharacteristic(FES_CHAR);
                
                const sensSvc = await server.getPrimaryService(SENSOR_SERVICE);
                sensorChar = await sensSvc.getCharacteristic(SENSOR_CHAR);
                
                await sensorChar.startNotifications();
                sensorChar.addEventListener('characteristicvaluechanged', handleNotifications);
                
                isConnected = true;
                updateStatus("Terhubung ‚úÖ", true);
                document.getElementById('connectButton').textContent = "Disconnect";
                document.getElementById('batteryStatus').style.display = 'flex';

            } catch (error) {
                console.error(error);
                updateStatus("Gagal Konek: " + error.message, false);
            }
        }

        function disconnect() {
            if(bleDevice && bleDevice.gatt.connected) bleDevice.gatt.disconnect();
        }

        function onDisconnect() {
            isConnected = false;
            updateStatus("Terputus ‚ùå", false);
            document.getElementById('connectButton').textContent = "Connect Device";
            document.getElementById('batteryStatus').style.display = 'none';
            resetSliders();
            if(isRecording) stopRecording(); // Auto save if disconnect mid-session
            showScreen('homeScreen'); // Kick to home
        }

        // --- 6. DATA HANDLING (THE BRAIN) ---
        function handleNotifications(event) {
            const str = decoder.decode(event.target.value);
            // Format v6.9: "Bicep:Grip:C1:C2:Bat%:BatV"
            const parts = str.split(':');
            if(parts.length < 6) return;

            const bicep = parseFloat(parts[0]);
            const grip = parseFloat(parts[1]);
            const c1 = parseInt(parts[2]);
            const c2 = parseInt(parts[3]);
            const batP = parseInt(parts[4]);
            const batV = parseFloat(parts[5]);

            // Update UI Elements
            updateSensorUI(grip, bicep);
            updateBatteryUI(batP, batV);
            
            // Jika di Manual Mode, update slider jika perlu (sync)
            // (Kode disederhanakan: user yang gerakin slider, jadi ga perlu update slider dari nilai balik kecuali auto)

            // Jika di Auto Mode, update text readout
            document.getElementById('autoC1Readout').textContent = c1;
            document.getElementById('autoC2Readout').textContent = c2;

            // RECORDING & CHARTING
            if(isRecording && currentUser) {
                const timeSec = ((Date.now() - recordingStartTime) / 1000).toFixed(1);
                
                // Masukkan ke data sesi
                currentSessionData.push({ t: timeSec, b: bicep, g: grip, c1: c1, c2: c2 });

                // Update Chart (Maks 50 poin biar gak berat)
                if(chartInstance) {
                    chartInstance.data.labels.push(timeSec);
                    chartInstance.data.datasets[0].data.push(grip);
                    chartInstance.data.datasets[1].data.push(bicep);
                    
                    if(chartInstance.data.labels.length > 50) {
                        chartInstance.data.labels.shift();
                        chartInstance.data.datasets[0].data.shift();
                        chartInstance.data.datasets[1].data.shift();
                    }
                    chartInstance.update();
                }
            }
        }

        function updateSensorUI(grip, bicep) {
            // Manual Mode UI
            document.getElementById('manGripVal').textContent = grip.toFixed(0) + "¬∞";
            document.getElementById('manGripGauge').style.width = Math.min((grip/270)*100, 100) + "%";
            
            document.getElementById('manBicepVal').textContent = bicep.toFixed(0) + "¬∞";
            document.getElementById('manBicepGauge').style.width = Math.min((bicep/120)*100, 100) + "%";
        }

        function updateBatteryUI(pct, volt) {
            document.getElementById('batteryText').textContent = pct + "%";
            document.getElementById('batteryVoltageText').textContent = volt.toFixed(2) + " V";
            const fill = document.getElementById('batteryFill');
            const width = (pct / 100) * 26; // 26 is max width inside SVG
            fill.setAttribute('width', width);
            
            if(pct < 20) fill.style.fill = "#d63031"; // Red
            else if(pct < 50) fill.style.fill = "#fdcb6e"; // Orange
            else fill.style.fill = "#00b894"; // Green
        }

        // --- 7. HISTORY & EXPORT ---
        function renderHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = "";
            
            if(!currentUser) {
                list.innerHTML = "<p>Mode Tamu tidak memiliki riwayat.</p>";
                return;
            }

            const history = JSON.parse(localStorage.getItem(currentUser.key)) || [];
            
            if(history.length === 0) {
                list.innerHTML = "<p style='text-align:center'>Belum ada data rekaman.</p>";
                return;
            }

            // Urutkan dari yang terbaru
            history.reverse().forEach((sess, index) => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    <div class="history-info">
                        <strong>Sesi #${history.length - index}</strong><br>
                        <span class="history-date">${sess.date} ‚Ä¢ Durasi: ${sess.duration}</span>
                    </div>
                    <button class="btn-success" style="width:auto; padding:5px 10px; font-size:0.8rem; margin:0;" onclick='downloadCSV(${index})'>Download CSV</button>
                `;
                list.appendChild(item);
            });
        }

        function downloadCSV(reverseIndex) {
            // Ambil data asli (karena tadi di-reverse untuk tampilan)
            const history = JSON.parse(localStorage.getItem(currentUser.key));
            // Hitung index asli array
            const realIndex = (history.length - 1) - reverseIndex;
            const session = history[realIndex];

            // Buat CSV Content
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Waktu(s),SudutGrip(deg),SudutBicep(deg),AmpC1,AmpC2\n"; // Header

            session.data.forEach(row => {
                csvContent += `${row.t},${row.g},${row.b},${row.c1},${row.c2}\n`;
            });

            // Trigger Download
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `RUBIFlex_${currentUser.name}_${session.date.replace(/[/,: ]/g, '_')}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- 8. UTILS & SENDERS ---
        async function sendCommand(cmd) {
            if(isConnected && controlChar) {
                try { await controlChar.writeValue(encoder.encode(cmd)); }
                catch(e) { console.log(e); }
            }
        }

        // Slider Listeners with Debounce
        const debounce = (func, delay) => {
            let timeout;
            return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func(...args), delay); };
        };
        const sendDebounced = debounce((cmd) => sendCommand(cmd), 50);

        function setupSlider(id, cmdPrefix) {
            const slider = document.getElementById(id + 'Slider');
            const input = document.getElementById(id + 'Input');
            
            slider.addEventListener('input', (e) => {
                input.value = e.target.value;
                sendDebounced(`${cmdPrefix}:${e.target.value}`);
            });
        }

        // Init Controls
        setupSlider('ch1Amp', 'C1:A');
        setupSlider('ch2Amp', 'C2:A');
        setupSlider('pw', 'C1:W'); // Global pulse width
        setupSlider('freq', 'C1:F'); // Global freq

        document.getElementById('ch1Enable').addEventListener('change', (e) => {
            document.getElementById('ch1AmpSlider').value = 0;
            document.getElementById('ch1AmpInput').value = 0;
            sendCommand(`C1:E:${e.target.checked ? 1 : 0}`);
            sendCommand(`C1:A:0`);
        });
        document.getElementById('ch2Enable').addEventListener('change', (e) => {
            document.getElementById('ch2AmpSlider').value = 0;
            document.getElementById('ch2AmpInput').value = 0;
            sendCommand(`C2:E:${e.target.checked ? 1 : 0}`);
            sendCommand(`C2:A:0`);
        });

        document.getElementById('targetGrip').addEventListener('change', (e) => sendDebounced(`AM:G:${e.target.value}`));
        document.getElementById('targetBicep').addEventListener('change', (e) => sendDebounced(`AM:B:${e.target.value}`));

        function updateStatus(msg, success) {
            const el = document.getElementById('status');
            el.textContent = msg;
            el.style.background = success ? '#dff9fb' : '#ff7675';
            el.style.color = success ? '#00b894' : '#fff';
        }

        function resetSliders() {
            ['ch1Amp','ch2Amp'].forEach(id => {
                document.getElementById(id+'Slider').value = 0;
                document.getElementById(id+'Input').value = 0;
            });
            document.getElementById('ch1Enable').checked = false;
            document.getElementById('ch2Enable').checked = false;
        }

    </script>
</body>
</html>
